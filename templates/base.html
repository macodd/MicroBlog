{% load static %}
<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"> -->

    <title> {% block title %}TweetMe.co{% endblock %}</title>

    <style>
        .red-color {
            color: red;
        }
        .grey-color {
            color: #c6c8ca;
        }
    </style>
</head>
<body>
    {% include 'navbar.html' %}

    <div class="container">
        {% block content %}

        {% endblock %}
    </div>

<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script>
        function loadTweetContainer(tweetContainerID) {
            const query = new URLSearchParams(window.location.search);
            var initial_url;
            var tweetContainer;

            if (tweetContainerID){
                tweetContainer = $("#" + tweetContainerID);
            } else {
                tweetContainer = $("#tweet-container");
            }

            initial_url = tweetContainer.attr("data-url") || '/api/tweet/';

            var tweetList = [];
            var nextTweetURL;

            $(document.body).on("click", '#retweetLink', function (event) {
                event.preventDefault();
                var url = "/api" + $(this).attr("href")
                $.ajax({
                    method: "GET",
                    url: url,
                    success: function (data) {
                        if (initial_url === '/api/tweet/'){
                            attachTweet(data, true, true);
                            updateHashLinks()
                        }
                    },
                    error: function (data) {
                        console.log("error", data);
                    }
                })
            })

            function updateHashLinks() {
                $('.media-body').each(function (data) {
                    var hashTagRegex = /(^|\s)#([\w\d-]+)/g;
                    var userNameRegex = /(^|\s)@([\w\d-]+)/g;
                    var newText;

                    newText = $(this).html().replace(hashTagRegex, "$1<a href='/tags/$2/'>#$2</a>");
                    $(this).html(newText);

                    newText = $(this).html().replace(userNameRegex, "$1<a href='/profiles/$2/'>@$2</a>");
                    $(this).html(newText);
                })
            }

            function attachTweet(tweetValue, preppend, retweet) {
                var tweetContent = tweetValue.content;
                var tweetUser = tweetValue.user;
                var tweetId = tweetValue.id;
                var tweetTimeStamp = tweetValue.date_display;
                var tweetFormattedHTML;

                if (retweet && tweetValue.parent) {
                    var mainTweet = tweetValue.parent;

                    tweetFormattedHTML = '<div class="media">' +
                        '{% if t.image %}' +
                            '<img src="..." class="mr-3" alt="...">' +
                            '{% endif %}' +
                        '<div class="media-body">' +
                        '<span class="grey-color">ReTweet via ' + tweetUser.username +
                        ' on ' + tweetTimeStamp + '</span><br/>' +
                        mainTweet.content + '<br/>' +
                        'via <a href="' + mainTweet.user.url + '">' +
                        mainTweet.user.username + '</a> | ' +
                        mainTweet.date_display + ' | <a href="/tweet/' + mainTweet.id + '">View</a> | ' +
                        '<a id="retweetLink" href="/tweet/' + mainTweet.id + '/retweet/">Retweet</a>' +
                        '</div></div><hr/>'
                } else {
                    tweetFormattedHTML = '<div class="media">' +
                        '{% if t.image %}' +
                            '<img src="..." class="mr-3" alt="...">' +
                            '{% endif %}' +
                        '<div class="media-body">' +
                        tweetContent + '<br/>' +
                        'via <a href="' + tweetUser.url + '">' +
                        tweetUser.username + '</a> | ' +
                        tweetTimeStamp + ' | <a href="/tweet/' + tweetId + '">View</a> | ' +
                        '<a id="retweetLink" href="/tweet/' + tweetValue.id + '/retweet/">Retweet</a>' +
                        '</div></div><hr/>'
                }
                if (preppend)
                    tweetContainer.prepend(tweetFormattedHTML);
                else
                    tweetContainer.append(tweetFormattedHTML);
            }

            function parseTweets() {
                if (tweetList === 0) {
                    tweetContainer.text("No tweets currently found.")
                } else {
                    // tweets exists
                    $.each(tweetList, function (k, value) {
                        if (value.parent) {
                            attachTweet(value, false, true);
                        } else {
                            attachTweet(value);
                        }
                    });
                }
            }

            function fetchTweets(url) {
                var fetchURL;
                if (!url) {
                    fetchURL = initial_url;
                } else {
                    fetchURL = url;
                }
                $.ajax({
                    url: fetchURL,
                    data: {'q': query.get('q')},
                    method: 'GET',
                    success: function (data) {
                        tweetList = data.results;
                        if (data.next)
                            nextTweetURL = data.next;
                        else
                            $('#loadMore').css('display', 'none')
                        parseTweets();
                        updateHashLinks();
                    },
                    error: function (data) {
                        console.log("error", data)
                    }
                })
            }

            fetchTweets()

            $('#loadMore').click(function (event) {
                event.preventDefault();
                if (nextTweetURL) {
                    fetchTweets(nextTweetURL);
                }
            })

            var tweetForm = $('#tweet-form');

            var charsStart = 140;
            var charsCurrent = 0;

            tweetForm.append("<span id='tweetCharsLeft'>" + charsStart + "</span>");

            $('#tweet-form textarea').keyup(function (event) {
                var tweetValue = $(this).val();
                var spanTweet = $('#tweetCharsLeft');
                charsCurrent = charsStart - tweetValue.length;
                spanTweet.text(charsCurrent);

                if (charsCurrent > 0) {
                    spanTweet.removeClass("grey-color");
                    spanTweet.removeClass("red-color");
                } else if (charsCurrent === 0) {
                    spanTweet.addClass("grey-color");
                    spanTweet.removeClass("red-color");
                } else if (charsCurrent < 0) {
                    spanTweet.addClass("red-color");
                    spanTweet.removeClass("grey-color");
                }
            })

            tweetForm.submit(function (event) {
                event.preventDefault();
                var this_ = $(this);
                var tweetData = $(this).serialize();

                if (charsCurrent >= 0) {
                    $.ajax({
                        url: '/api/tweet/create/',
                        data: tweetData,
                        method: 'POST',
                        success: function (data) {
                            this_.find("input[type=text], textarea").val("")
                            attachTweet(data, true);
                            updateHashLinks();
                        },
                        error: function (data) {
                            console.log("error", data);
                        }
                    })
                } else {
                    console.log("Too long.");
                }
            })
        }
    </script>
    {% block script %}{% endblock %}

    <script>
        $(document).ready(function () {
            var typingTimer;
            var doneInterval = 800;  // miliseconds
            var searchInput = $('#navbar-search-form input[type=text]')
            var searchQuery;

            searchInput.keyup(function (event) {
                searchQuery = $(this).val()
                clearTimeout(typingTimer)  // clearing timer
                typingTimer = setTimeout(doneSearchTyping, doneInterval)  // reset

            })

            searchInput.keydown(function (event) {
                clearTimeout(typingTimer)
            })

            function doneSearchTyping(){
                if (searchQuery){
                    document.location.href = '/tweet/search/?q=' + searchQuery;
                }
            }
        })

    </script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" ></script>
<script src="{% static 'js/bootstrap.min.js' %}"></script>
<!-- <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" ></script> -->
</body>
</html>